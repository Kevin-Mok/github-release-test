@Library('jenkins-pipeline-shared-libraries-kmok')_

pipeline {
    agent { label 'kie-rhel7-priority' }
    environment {
        NEW_BRANCH = "${JOB_BASE_NAME}-${BUILD_NUMBER}"
        COMMIT_MSG = "Add build tag to README"
        CREDS_ID = "kmok-github-bot"
    }
    stages {
        stage('Clone repositories') { 
            steps {
                dir("github-release-test") {
                    script {
                        cleanWs()
                        sh "rm -rf ~/.config/hub"
                        checkout(githubscm.resolveRepository("jenkins-test", "Kevin-Mok", "master", false))
                        githubscm.forkRepo("kmok-github-bot")
                        githubscm.createBranch(NEW_BRANCH)
                        sh '''
                        git status
                        ls -a
                        printf \"${BUILD_TAG}\n\" >> README.md
                        git status
                        '''
                        githubscm.commitChanges("Jenkins", "nzxt@jenkins.com", COMMIT_MSG)
                        githubscm.pushObject("origin", NEW_BRANCH, CREDS_ID)
                        sh "git status"
                        echo githubscm.createPR(COMMIT_MSG, "master", CREDS_ID)
                    }
                }
            }
        }
    }
}
